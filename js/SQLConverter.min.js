class SQLConverter{constructor(){this.dbToSqlite={int:"INTEGER",bit:"BOOLEAN","tinyint(1)":"BOOLEAN",tinyint:"INTEGER",smallint:"INTEGER",mediumint:"INTEGER",bigint:"INTEGER",real:"REAL",float:"REAL",double:"REAL",decimal:"REAL",nvarchar:"NVARCHAR",varchar:"NVARCHAR","character varying":"NVARCHAR",char:"NVARCHAR",tinytext:"TEXT",mediumtext:"TEXT",longtext:"TEXT",text:"TEXT",datetime2:"TIMESTAMP",datetime:"DATETIME",timestamp:"TIMESTAMP",date:"DATE",time:"TIME",year:"INTEGER",boolean:"INTEGER",json:"TEXT",jsonb:"TEXT",integer:"INTEGER",serial:"INTEGER",bigserial:"INTEGER","double precision":"REAL",timestamptz:"TIMESTAMP"},this.dbToMySQL={bigint:"BIGINT",bigserial:"BIGINT",serial:"BIGINT",mediumint:"MEDIUMINT",smallint:"SMALLINT",integer:"INT",double:"DOUBLE",float:"FLOAT",real:"DOUBLE",decimal:"DECIMAL",numeric:"NUMERIC",tinytext:"TINYTEXT",mediumtext:"MEDIUMTEXT",longtext:"LONGTEXT",text:"TEXT",nvarchar:"VARCHAR",varchar:"VARCHAR","character varying":"VARCHAR","tinyint(1)":"TINYINT(1)",tinyint:"TINYINT",boolean:"TINYINT(1)",bit:"TINYINT(1)",int:"INT",datetime2:"TIMESTAMP",datetime:"DATETIME",date:"DATE",timestamptz:"TIMESTAMP","timestamp with time zone":"TIMESTAMP","timestamp without time zone":"DATETIME",timestamp:"TIMESTAMPTZ",json:"JSON",enum:"ENUM",set:"SET",char:"CHAR"},this.dbToPostgreSQL={bigint:"BIGINT",mediumint:"INTEGER",smallint:"INTEGER","tinyint(1)":"BOOLEAN",tinyint:"INTEGER",integer:"INTEGER",int:"INTEGER",real:"REAL",longtext:"TEXT",mediumtext:"TEXT",smalltext:"TEXT",tinytext:"TEXT",text:"TEXT","character varying":"CHARACTER VARYING",nvarchar:"CHARACTER VARYING",varchar:"CHARACTER VARYING",char:"CHARACTER",boolean:"BOOLEAN",bit:"BOOLEAN",datetime2:"TIMESTAMP WITH TIME ZONE",datetime:"TIMESTAMP WITHOUT TIME ZONE",date:"DATE",timestamptz:"TIMESTAMP WITH TIME ZONE",timestamp:"TIMESTAMP WITH TIME ZONE",time:"TIME",json:"JSONB"}}replaceAll(e,t,r){if(void 0===e)return null;let i=RegExp(t,"gi");return e.replace(i,r)}translate(e,t){let r=[],i=this.extractDropTableQueries(e,t);for(let a in i)r.push("-- DROP TABLE IF EXISTS "+i[a].table+";");e=this.replaceAll(e,"`",""),e=this.replaceAll(e," timestamp with time zone"," timestamptz"),e=this.replaceAll(e," timestamp without time zone"," timestamp"),e=this.replaceAll(e," character varying"," varchar"),e=this.replaceAll(e,' COLLATE pg_catalog."default"',""),e=this.replaceAll(e," TINYINT(1)"," boolean");let l=new TableParser;l.parseAll(e);let s=l.getResult(),T=[];for(let n in s){let o=this.convertQuery(s[n],t);T.push(o),T.push("")}return r.length>0&&r.push("\r\n\r\n"),r.join("\r\n")+T.join("\r\n")}convertQuery(e,t){return this.isSQLite(t)?this.toSqliteOut(e,t):this.isMySQL(t)?this.toMySQLOut(e,t):this.isPGSQL(t)?this.toPostgreSQLOut(e,t):void 0}toSqliteOut(e,t){let r={tableName:e.tableName,primaryKey:e.primaryKey,columns:e.columns.map(e=>{let t={...e};return t.Type=this.toSqliteType(t.Type,t.Length),t})};return this.toSqliteTable(r,t)}toMySQLOut(e,t){let r={tableName:e.tableName,primaryKey:e.primaryKey,columns:e.columns.map(e=>{let t={...e,Field:e.Field};return t.Type=this.toMySQLType(t.Type,t.Length,t.EnumValues),t})};return this.toMySQLTable(r,t)}toPostgreSQLOut(e,t){let r={tableName:e.tableName,primaryKey:e.primaryKey,columns:e.columns.map(e=>{let t={...e};return t.Type=this.toPostgreSQLType(t.Type,t.Length),t})};return this.toPostgreSQLTable(r,t)}toSqliteTable(e,t){return this.toTable(e,t)}toMySQLTable(e,t){return this.toTable(e,t)}toPostgreSQLTable(e,t){return this.toTable(e,t)}isMySQL(e){return"mysql"===e||"mariadb"===e}isPGSQL(e){return"pgsql"===e||"postgresql"===e}isSQLite(e){return"sqlite"===e}isReal(e){return -1!=e.toUpperCase().indexOf("FLOAT")||-1!=e.toUpperCase().indexOf("DOUBLE")||-1!=e.toUpperCase().indexOf("REAL")||-1!=e.toUpperCase().indexOf("DECIMAL")}isBoolean(e){return"BOOLEAN"==e.toUpperCase()||"BOOL"==e.toUpperCase()||"TINYINT(1)"==e.toUpperCase()}isTinyInt1(e,t){return"TINYINT"===e.toUpperCase()&&1==t||"BIT"===e.toUpperCase()||"BOOLEAN"===e.toUpperCase()}isInteger(e){return"TINYINT"===e.toUpperCase()||"SMALLINT"===e.toUpperCase()||"MEDIUMINT"===e.toUpperCase()||"BIGINT"===e.toUpperCase()||"INTEGER"===e.toUpperCase()||"INT"===e.toUpperCase()}isAutoIncrement(e,t){return this.isMySQL(t)&&e}isNotEmpty(e){return null!=e&&""!=e}hasDefaultValue(e,t){return!e&&null!==t&&""!==t}fixTableName(e,t){return -1!==e.indexOf(".")&&(e=e.split(".")[1]),this.isMySQL(t)?e="`"+e+"`":this.isPGSQL(t)&&(e='"'+e+'"'),e}fixColumnName(e,t){return this.isMySQL(t)&&(e="`"+e+"`"),e}getDefaultData(e,t){let r="";return"NULL"==e.toUpperCase()?r+=" DEFAULT NULL":this.isBoolean(t)?r+=" DEFAULT "+this.convertToBolean(e):-1!=t.toUpperCase().indexOf("INT")?r+=" DEFAULT "+this.convertToInteger(e):this.isReal(t)?r+=" DEFAULT "+this.convertToReal(e):r+=" DEFAULT "+e,r}toTable(e,t){let r=e.tableName,i=[];i.push(`CREATE TABLE IF NOT EXISTS ${r=this.fixTableName(r,t)} (`);let a=[];for(let l in e.columns){let s=this.fixColumnName(e.columns[l].Field,t),T=e.columns[l].Type,n=e.columns[l].Key||e.columns[l].Field===e.primaryKey,o="	"+s+" "+T;n?(o+=" PRIMARY KEY",this.isAutoIncrement(e.columns[l].AutoIncrement,t)&&(o+=" AUTO_INCREMENT"),e.columns[l].Nullable=!1):e.columns[l].Nullable?o+=" NULL":o+=" NOT NULL";let E=e.columns[l].Default;this.hasDefaultValue(n,E)&&(E=this.replaceAll(E,"::character varying",""),E=this.fixDefaultValue(E,t),this.isNotEmpty(E)&&(o+=this.getDefaultData(E,T))),null!=e.columns[l].Comment&&(o+=` COMMENT '${this.addslashes(e.columns[l].Comment)}'`),a.push(o)}i.push(a.join(",\r\n")),i.push(");");let p=i.join("\r\n");return p.replace(/boolean\s+null\s+default\s+true/gi,"BOOLEAN NULL DEFAULT 1").replace(/boolean\s+null\s+default\s+false/gi,"BOOLEAN NULL DEFAULT 0").replace(/boolean\s+default\s+true/gi,"BOOLEAN NULL DEFAULT 1").replace(/boolean\s+default\s+false/gi,"BOOLEAN NULL DEFAULT 0")}addslashes(e){return e.replace(/'/g,"''")}convertToInteger(e){let t=e.replace(/^'|'$/g,"");return""===t?0:parseInt(t,10)}convertToReal(e){let t=e.replace(/^'|'$/g,"");if(""===t)return 0;let r=parseFloat(t);return isNaN(r)?0:r}convertToBolean(e){return -1!=e.indexOf("1")||-1!=e.toUpperCase().indexOf("TRUE")?"TRUE":"FALSE"}fixDefaultValue(e,t){return this.isSQLite(t)&&-1!==e.toLowerCase().indexOf("now(")&&(e=""),e}toSqliteType(e,t){if(this.isTinyInt1(e,t))return"BOOLEAN";let r="TEXT";for(let i in this.dbToSqlite)if(this.dbToSqlite.hasOwnProperty(i)){let a=i.toString();if(e.toLowerCase().startsWith(a.toLowerCase())){r=this.dbToSqlite[a];break}}if(-1!=e.toUpperCase().indexOf("ENUM")||-1!=e.toUpperCase().indexOf("SET")){let{resultArray:l,maxLength:s}=this.parseEnumValue(t);r="NVARCHAR("+(s+2)+")"}else("NVARCHAR"===r||"INT"===r)&&t>0&&(r=r+"("+t+")");return r}toMySQLType(e,t,r){let i="TEXT";if(this.isTinyInt1(e,t))return"TINYINT(1)";if(this.isInteger(e)&&t>0)return`${e}(${t})`;for(let a in this.dbToMySQL)if(this.dbToMySQL.hasOwnProperty(a)){let l=a.toString();if(e.toLowerCase().startsWith(l.toLowerCase())){i=this.dbToMySQL[l];break}}if(i=this.replaceAll(i,"TIMESTAMPTZ","TIMESTAMP"),-1!=e.toUpperCase().indexOf("ENUM"))i="ENUM('"+r.join("','")+"')";else if(-1!=e.toUpperCase().indexOf("SET"))i="SET('"+r.join("','")+"')";else if(-1!=e.toUpperCase().indexOf("DECIMAL")){let{resultArray:s,maxLength:T}=this.parseNumericType(t);i="DECIMAL("+s.join(",")+")"}else if(-1!=e.toUpperCase().indexOf("NUMERIC")){let{resultArray:n,maxLength:o}=this.parseNumericType(t);i="NUMERIC("+n.join(",")+")"}return("VARCHAR"===i||"CHAR"===i)&&t>0&&(i=i+"("+t+")"),i}toPostgreSQLType(e,t){let r="TEXT";for(let i in this.dbToPostgreSQL)if(this.dbToPostgreSQL.hasOwnProperty(i)){let a=i.toString();if(e.toLowerCase().startsWith(a.toLowerCase())){r=this.dbToPostgreSQL[a];break}}if(-1!=e.toUpperCase().indexOf("TINYINT")&&1==t)r="BOOLEAN";else if(-1!=e.toUpperCase().indexOf("ENUM")||-1!=e.toUpperCase().indexOf("SET")){let{resultArray:l,maxLength:s}=this.parseEnumValue(t);r="CHARACTER VARYING("+(s+2)+")"}else("CHARACTER VARYING"===r||"CHARACTER"===r||"CHAR"===r)&&t>0&&(r=r+"("+t+")");return r}parseEnumValue(e){let t=/'([^']+)'/g,r,i=[];for(;null!==(r=t.exec(e));)i.push(r[1]);let a=i.reduce((e,t)=>t.length>e?t.length:e,0);return{resultArray:i,maxLength:a}}parseNumericType(e){let t=/([A-Za-z0-9_]+)/g,r,i=[];for(;null!==(r=t.exec(e));)i.push(r[1]);let a=i.reduce((e,t)=>t.length>e?t.length:e,0);return{resultArray:i,maxLength:a}}extractDropTableQueries(e,t){let r=e.replace(/`/g,""),i=/DROP TABLE IF EXISTS ([^\s]+)/gi,a,l=[];for(;null!==(a=i.exec(r));){let s=this.extractTableName(a[1]);this.isPGSQL(t)?s='"'+s+'"':this.isMySQL(t)&&(s="`"+s+"`"),l.push({table:s})}return l}extractTableName(e){return e.includes(".")&&(e=e.split(".")[1]),e.replace(/[^a-zA-Z0-9_]/g,"")}}