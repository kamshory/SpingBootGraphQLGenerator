class EntityRenderer{constructor(t){this.selector=t,this.svg=document.querySelector(this.selector),this.tables={},this.xPadding=5,this.yPadding=5,this.betweenX=20,this.betweenY=20,this.tableWidth=220,this.maxTop=0,this.maxCol=0,this.lastMaxCol=0,this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.entityStrokeWidth="0.5",this.stroke="#8496B1",this.columnTextColor="#3a4255",this.columnHeight=20,this.columnTypeFontSize=9,this.columnFontSize=11,this.headerBackgroundColor="#d8e8ff",this.buttonSpace=16,this.buttonMargin=6,this.buttonWidth=14,this.buttonHeight=14,this.buttonFontSize=10,this.tableFontSize=12,this.relationStrokeWidth=.7,this.width=1,this.drawRelationship=!1}initIconEvent(t){let e=this;this.svg.addEventListener("click",function(i){i.target.closest(".erd-svg .move-down-icon")&&t.moveEntityUp(parseInt(i.target.dataset.index),function(){e.createERD(e.data,e.width,e.drawRelationship)}),i.target.closest(".erd-svg .move-up-icon")&&t.moveEntityDown(parseInt(i.target.dataset.index),function(){e.createERD(e.data,e.width,e.drawRelationship)})})}createERD(t,e,i){this.drawRelationship=i,this.width=e,this.svg=document.querySelector(this.selector),this.lastMaxCol=0,this.maxCol=0,this.svg.innerHTML="",this.data=t,this.svg.setAttribute("width",e);let n=this.xPadding,s=this.yPadding,a=n,r=s,l=0,h=0;this.data.entities.forEach(t=>{let i=this.createTable(t,t.index,a,r);this.tables[t.name]={table:i,xPos:a,yPos:r},this.maxCol<t.columns.length&&(this.maxCol=t.columns.length),this.lastMaxCol=this.maxCol,a+=this.betweenX+this.tableWidth,++h>l&&(l=h),a>e-this.tableWidth-1&&(a=n,r+=this.maxCol*this.columnHeight+this.betweenY+30,this.maxCol=0,h=0),this.maxTop=r});let o=r;h>0?o+=this.maxCol*this.columnHeight+30:o-=this.betweenY;let d=2*this.xPadding+l*(this.betweenX+this.tableWidth)-this.betweenX+2,c=2*this.yPadding+o-2;this.svg.setAttribute("height",c),this.svg.setAttribute("width",d),i&&this.createRelationships(),this.svg=document.querySelector(this.selector)}createRelationships(){this.data.entities.forEach(t=>{t.columns.forEach((e,i)=>{if(e.name.endsWith("_id")){let n=e.name.replace("_id","");t.name!=n&&this.tables[n]&&this.createRelationship(t,e,i)}})})}createOffset(t){return t*this.buttonSpace+this.buttonMargin}createTable(t,e,i,n){let s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("data-entity",t.name),s.classList.add("svg-entity"),s.setAttribute("data-index",e),s.setAttribute("transform",`translate(${i}, ${n})`);let a=t.columns.length*this.columnHeight+26,r=this.createSvgRect(0,0,this.tableWidth,a,"#ffffff",this.stroke,this.entityStrokeWidth);s.appendChild(r);let l=this.createSvgRect(1,1,this.tableWidth-2,24,this.headerBackgroundColor);s.appendChild(l);let h=this.createSvgForeignText(10,5,this.tableWidth-60,18,t.name);return s.appendChild(h),[{icon:"⬅️",offset:2,className:"move-up-icon"},{icon:"➡️",offset:1,className:"move-down-icon"},].forEach(({icon:t,offset:i,className:n})=>{let a=this.tableWidth-this.createOffset(i),r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",a),r.setAttribute("y",17),r.setAttribute("font-size",this.buttonFontSize),r.textContent=t,s.appendChild(r);let l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x",a),l.setAttribute("y",7),l.setAttribute("width",this.buttonWidth),l.setAttribute("height",this.buttonHeight),l.setAttribute("fill","transparent"),l.setAttribute("class",n),l.setAttribute("data-index",e),l.style.cursor="pointer",s.appendChild(l)}),t.columns.forEach((t,e)=>{let i=40+e*this.columnHeight,n=26+e*this.columnHeight;if(t.primaryKey){let a=this.createSvgRect(1,n+1,this.tableWidth-2,this.columnHeight-2,"#f4f8ff");s.appendChild(a)}let r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",10),r.setAttribute("y",i),r.setAttribute("font-size",this.columnFontSize),r.setAttribute("fill",this.columnTextColor),r.textContent=t.name,r.classList.add("diagram-column-name"),s.appendChild(r);let l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("x",this.tableWidth-10),l.setAttribute("y",i),l.setAttribute("font-size",this.columnTypeFontSize),l.setAttribute("fill",this.columnTextColor),l.setAttribute("text-anchor","end");let h=this.getFormattedType(t);l.textContent=h,s.appendChild(l);let o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",0),o.setAttribute("y1",n),o.setAttribute("x2",this.tableWidth),o.setAttribute("y2",n),o.setAttribute("stroke",this.stroke),o.setAttribute("stroke-width",this.entityStrokeWidth),s.appendChild(o)}),this.svg.appendChild(s),s}createSvgRect(t,e,i,n,s="transparent",a="none",r=0){let l=document.createElementNS("http://www.w3.org/2000/svg","rect");return l.setAttribute("x",t),l.setAttribute("y",e),l.setAttribute("width",i),l.setAttribute("height",n),l.setAttribute("fill",s),l.setAttribute("stroke",a),l.setAttribute("stroke-width",r),l}createSvgForeignText(t,e,i,n,s){let a=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");a.setAttribute("x",t),a.setAttribute("y",e),a.setAttribute("width",i),a.setAttribute("height",n);let r=document.createElement("div");return r.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),r.style.cssText=`font-size: 12px; font-family: sans-serif; color: #1d3c86; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; height: ${n}px;`,r.textContent=s,a.appendChild(r),a}getFormattedType(t){return this.withLengthTypes.includes(t.type)&&t.length>0?`${t.type}(${t.length})`:this.withRangeTypes.includes(t.type)&&null!=t.values?`${t.type}(${t.values})`:`${t.type}`}createRelationship(t,e,i){let n=e.name.replace("_id",""),s=this.getEntityByName(n);if(null!=s){let a=this.getColumnIndex(s,e.name),r=this.tables[t.name].table,l=this.tables[n].table,h=i*this.columnHeight+this.tables[t.name].yPos+36,o=parseInt(r.getAttribute("transform").split(",")[0].replace("translate(","")),d=parseInt(l.getAttribute("transform").split(",")[0].replace("translate(","")),c=a*this.columnHeight+this.tables[n].yPos+36,u,m;o==d?(o+=4,d+=4,u=o-8,m=d-8):o<=d?(o+=this.tableWidth,o-=4,d+=4,u=o+8,m=d-8):(d+=this.tableWidth,o+=4,d-=4,u=o-8,m=d+8);let g=document.createElementNS("http://www.w3.org/2000/svg","circle"),p=document.createElementNS("http://www.w3.org/2000/svg","circle");g.setAttribute("cx",o),g.setAttribute("cy",h),g.setAttribute("r",3),g.setAttribute("fill","#2A56BD"),p.setAttribute("cx",d),p.setAttribute("cy",c),p.setAttribute("r",3),p.setAttribute("fill","#CC0088");let b=document.createElementNS("http://www.w3.org/2000/svg","path"),w=`M ${o} ${h} L ${u} ${h} L ${m} ${c} L ${d} ${c}`;b.setAttribute("d",w),b.setAttribute("stroke","#2A56BD"),b.setAttribute("stroke-width",this.relationStrokeWidth),b.setAttribute("fill","transparent"),this.svg.appendChild(b),this.svg.appendChild(g),this.svg.appendChild(p)}}getEntityByName(t){return this.data.entities.find(e=>e.name===t)}getColumnIndex(t,e){return t.columns.findIndex(t=>t.name===e)}downloadSVG(){let t=this.getFileName()+".svg";this.exportToSVG(this.svg,t)}downloadPNG(){let t=this.getFileName()+".png";this.exportToPNG(this.svg,t)}downloadMD(){let t=this.getFileName()+".md";this.exportToMD(t)}getFileName(){let t=document.querySelector(".diagram-list.tabs").querySelector('.diagram-tab.active input[type="text"]'),e=document.querySelector('meta[name="application-id"]').getAttribute("content"),i=document.querySelector('meta[name="database-name"]').getAttribute("content"),n="",s="";return s=""!=i?i:e,n=null!=t?s+" - "+t.value:s}generateSVGString(t){let e=t.clientWidth,i=t.clientHeight+2,n=new XMLSerializer().serializeToString(t);return`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${e}" height="${i}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                        .move-up-icon, .move-down-icon, .edit-icon, .delete-icon {
                            display: none;
                            visibility: hidden;
                            opacity: 0;
                            pointer-events: none;
                        }
                    ]]>
                </style>
            </defs>
            ${n}
        </svg>`}exportToSVG(t,e="exported-image.svg"){let i=this.generateSVGString(t),n=new Blob([i],{type:"image/svg+xml"}),s=URL.createObjectURL(n),a=document.createElement("a");a.href=s,a.download=e,a.click(),URL.revokeObjectURL(s)}exportToPNG(t,e="exported-image.png"){let i=t.clientWidth,n=t.clientHeight,s=document.createElement("canvas");s.width=i,s.height=n;let a=s.getContext("2d"),r=this.generateSVGString(t),l="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(r),h=new Image;h.onload=function(){a.drawImage(h,0,0);let t=s.toDataURL("image/png"),i=document.createElement("a");i.href=t,i.download=e,i.click()},h.onerror=function(t){console.error("Error loading the SVG image:",t)},h.src=l}exportToMD(t="exported.md"){let e=this,i=`# Entity Documentation

`;i+=`This document provides an overview of all entity structures in the system, including table metadata and column definitions.

`,i+=`---

`,i+=`## Entities

`,this.data.entities.forEach(t=>{i+=`### ${t.name}

`,t.description&&(i+=`**Description:** ${t.description}

`),t.creationDate&&(i+=`**Created on:** ${e.formatDate(t.creationDate)}
`),t.creator&&""!==t.creator&&"{{userName}}"!==t.creator&&(i+=`**Created by:** ${t.creator}
`),t.modificationDate&&(i+=`**Updated on:** ${e.formatDate(t.modificationDate)}
`),t.modifier&&""!==t.modifier&&"{{userName}}"!==t.modifier&&(i+=`**Updated by:** ${t.modifier}
`),i+=`
`;let n="Column Name",s="Type",a="Null",r=Math.max(...t.columns.map(t=>t.name.length),n.length),l=Math.max(...t.columns.map(t=>this.getFormattedType(t).length),s.length),h=Math.max(a.length,4);r<30&&(r=30),l<13&&(l=13),i+=`| ${n.padEnd(r)} | ${s.padEnd(l)} | ${a.padEnd(h)} | ${"Key".padEnd(3)} | ${"AI".padEnd(3)} |
`,i+=`| ${"-".repeat(r)} | ${"-".repeat(l)} | ${"-".repeat(h)} | ${"-".repeat(3)} | ${"-".repeat(3)} |
`,t.columns.forEach(t=>{let e=this.getFormattedType(t),n=t.nullable?"YES":"NO",s=t.primaryKey?"YES":"NO",a=t.autoIncrement?"YES":"NO";i+=`| ${t.name.padEnd(r)} | ${e.padEnd(l)} | ${n.padEnd(h)} | ${s.padEnd(3)} | ${a.padEnd(3)} |
`}),i+=`
`}),i+=`---

`,i+=`*Generated automatically by MagicAppBuilder.*
`,i+=`*This file reflects the current state of the data entities in the system as of ${e.formatDate(new Date)}.*
`;let n=new Blob([i],{type:"text/markdown"}),s=URL.createObjectURL(n),a=document.createElement("a");a.href=s,a.download=t,a.click(),URL.revokeObjectURL(s)}formatDate(t){let e=new Date(t);return e.toLocaleDateString("en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(",","")}getSVGElement(){return this.svg}createDescription(t,e){let i=this,n=document.querySelector(e);n.innerHTML="",t.entities&&t.entities.forEach(t=>{i.addDescription(t,n)})}addDescription(t,e){let i=document.createElement("div");i.classList.add("mb-4");let n=document.createElement("h5");n.textContent=t.name,i.appendChild(n);let s=document.createElement("table");s.className="table table-bordered table-striped table-sm",s.style.width="100%",s.style.tableLayout="fixed";let a=document.createElement("thead");a.innerHTML=`
            <tr>
                <th style="width: 30%;">Column</th>
                <th style="width: 25%;">Type</th>
                <th style="width: 10%;">PK</th>
                <th style="width: 15%;">Nullable</th>
                <th style="width: 20%;">Default</th>
            </tr>
        `,s.appendChild(a);let r=document.createElement("tbody");t.columns.forEach(t=>{let e=document.createElement("tr"),i=t.type||"";null!=t.length&&""!==t.length&&(i+=`(${t.length})`),e.innerHTML=`
                <td>${t.name||""}</td>
                <td>${i}</td>
                <td style="text-align: center;">${t.primaryKey?"✓":""}</td>
                <td style="text-align: center;">${t.nullable?"YES":"NO"}</td>
                <td>${null!=t.defaultValue?t.defaultValue:""}</td>
            `,r.appendChild(e)}),s.appendChild(r),i.appendChild(s),e.appendChild(i)}}