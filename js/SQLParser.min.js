class SQLParser{constructor(){this.entities=[]}looksLikeSQLite(e){return[83,81,76,105,116,101,32,102,111,114,109,97,116,32,51,0].every((t,r)=>e[r]===t)}importSQLite(e,t){if(!e)return;let r=this,a=new FileReader;a.onload=function(e){let a=e.target.result,l=new Uint8Array(a);initSqlJs({locateFile:e=>"wasm/sql-wasm.wasm"}).then(e=>{r.db=new e.Database(l);let a=r.db.exec("SELECT name FROM sqlite_master WHERE type='table';"),n=[];if(a[0].values.forEach((e,t)=>{let a=e[0],l=new Entity(stringUtil.snakeize(a),t),i=r.db.exec(`SELECT * FROM ${a};`);if(i.length>0){let o=i[0].columns,s=i[0].values;l.creationDate=new Date().getTime(),l.modificationDate=l.creationDate,l.creator="{{userName}}",l.modifier="{{userName}}",l.data=s.map(e=>{let t={};return o.forEach((r,a)=>{let l=stringUtil.snakeize(r);t[l]=e[a]}),t})}else l.setData(null);let u=r.db.exec(`PRAGMA table_info(${a});`);if(u.length>0){let m=!1,f=u[0].values.filter(e=>e[5]).length>1;u[0].values.forEach(e=>{let t="INTEGER"==e[2].toUpperCase()&&e[5];(m||f)&&(t=!1);let a=stringUtil.snakeize(e[1]),n=r.toMySqlType(e[2]),i=r.getColumnSize(e[2]),o=1===e[3],s=e[4],u=e[5];(null==i||0==i)&&"BIGINT"==n&&(i="20");let c=new Column(a,n,i,o,s,u,t,null);l.addColumn(c),m&&(m=!1)}),n.push(l)}}),r.clearBeforeImport)r.entities=n;else{let i=[];r.entities.forEach(e=>{i.push(e.name)}),n.forEach(e=>{i.includes(e.name)||(e.index=r.entities.length,r.entities.push(e))})}"function"==typeof t&&t({entities:n=r.calculateEntityDepth(n)})})},a.readAsArrayBuffer(e)}importSQLQuery(e,t){let r=this,a=new FileReader;a.onload=function(e){let a=e.target.result;try{let l=new SQLConverter,n=l.translate(a,"mysql").replace(/`/g,""),i=new TableParser(n);i.parseData(a);let o=r.createEntitiesFromSQL(i.tableInfo);"function"==typeof t&&(o=r.calculateEntityDepth(o),t({entities:o}))}catch(s){console.log("Error parsing SQL: "+s.message)}},a.onerror=()=>{},a.readAsText(e)}createEntitiesFromSQL(e){let t=[];return e.forEach((e,r)=>{let a=new Entity(e.tableName,r);e.columns.forEach(e=>{let t=new Column(e.Field,e.Type.toUpperCase(),e.Length,e.Nullable,e.Default,e.Key,e.AutoIncrement,null!=e.EnumValues&&"object"==typeof e.EnumValues?e.EnumValues.join(", "):null,null);a.addColumn(t)}),a.creationDate=new Date().getTime(),a.modificationDate=a.creationDate,a.creator="{{userName}}",a.modifier="{{userName}}",t.push(a)}),t}importSQLFile(e,t){let r=this,a=new FileReader,l=e.slice(0,512);a.onload=function(a){let l=new Uint8Array(a.target.result);r.looksLikeSQLite(l)?r.importSQLite(e,t):r.importSQLQuery(e,t)},a.onerror=()=>{},a.readAsArrayBuffer(l)}toMySqlType(e){if(!e)return"TEXT";let t=e.trim().toUpperCase();for(let[r,a]of[[/NVARCHAR/,"VARCHAR"],[/INT/,"BIGINT"],[/(CHAR|CLOB|TEXT)/,"TEXT"],[/BLOB/,"BLOB"],[/(REAL|FLOA|DOUB)/,"DOUBLE"],[/(NUMERIC|DECIMAL)/,"DECIMAL"],[/BOOLEAN/,"TINYINT"],[/TIMESTAMP/,"TIMESTAMP"],[/(DATE|TIME)/,"DATETIME"]])if(r.test(t))return a;return e}getColumnSize(e){if(!e)return null;if(-1!==e.toUpperCase().indexOf("BOOL"))return 1;let t=e.match(/\((\d+)\)/);return t&&t[1]?parseInt(t[1]):null}toValidTableName(e){return e.replace(/\.[^/.]+$/,"").replace(/[^a-zA-Z0-9]+/g,"_").toLowerCase().replace(/^_+|_+$/g,"")}calculateEntityDepth(e,t=!1){let r=Object.fromEntries(e.map(e=>[e.name,e])),a={};for(let l of e){let n=l.columns.filter(e=>e.name.endsWith("_id")).map(e=>e.name.replace(/_id$/,"")).filter(e=>e!==l.name&&r[e]);a[l.name]=n}let i=new Map;function o(e,t=new Set){if(i.has(e))return i.get(e);if(t.has(e))return 0;t.add(e);let r=a[e]||[],l=r.length>0?Math.max(...r.map(e=>o(e,new Set(t)))):0,n=l+1;return i.set(e,n),n}for(let s of e)s.depth=o(s.name);if(t){let u=Math.max(...e.map(e=>e.depth));for(let m of e)m.depth=u-m.depth}return e}sortEntitiesByDepth(e,t=!1){if(t){let r=Math.max(...e.map(e=>e.depth));for(let a of e)a.depth=r-a.depth}return[...e].sort((e,t)=>e.depth-t.depth)}}